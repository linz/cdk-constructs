"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const aws_sdk_1 = require("aws-sdk");
const ecs = new aws_sdk_1.ECS();
const getProperties = (props) => ({
    cluster: props.Cluster,
    serviceName: props.ServiceName,
    containerName: props.ContainerName,
    taskDefinition: props.TaskDefinition,
    launchType: props.LaunchType,
    platformVersion: props.PlatformVersion,
    desiredCount: props.DesiredCount,
    subnets: props.Subnets,
    securityGroups: props.SecurityGroups,
    targetGroupArn: props.TargetGroupArn,
    containerPort: props.ContainerPort,
    schedulingStrategy: props.SchedulingStrategy,
    healthCheckGracePeriodSeconds: props.HealthCheckGracePeriod,
    deploymentConfiguration: props.DeploymentConfiguration,
});
const onCreate = async (event) => {
    const { cluster, serviceName, containerName, taskDefinition, launchType, platformVersion, desiredCount, subnets, securityGroups, targetGroupArn, containerPort, schedulingStrategy, healthCheckGracePeriodSeconds, deploymentConfiguration, } = getProperties(event.ResourceProperties);
    const { service } = await ecs
        .createService({
        cluster,
        serviceName,
        taskDefinition,
        launchType,
        platformVersion,
        desiredCount,
        schedulingStrategy,
        deploymentController: {
            type: 'CODE_DEPLOY',
        },
        networkConfiguration: {
            awsvpcConfiguration: {
                subnets,
                securityGroups,
            },
        },
        deploymentConfiguration,
        healthCheckGracePeriodSeconds,
        loadBalancers: [
            {
                targetGroupArn: targetGroupArn,
                containerPort,
                containerName,
            },
        ],
    })
        .promise();
    if (!service)
        throw Error('Service could not be created');
    return {
        PhysicalResourceId: service.serviceArn,
        Data: {
            ServiceName: service.serviceName,
        },
    };
};
/**
 * For services using the blue/green (CODE_DEPLOY) deployment controller,
 * only the desired count, deployment configuration, task placement constraints
 * and strategies, and health check grace period can be updated using this API.
 * If the network configuration, platform version, or task definition need to be
 * updated, a new AWS CodeDeploy deployment should be created.
 * For more information, see CreateDeployment in the AWS CodeDeploy API Reference.
 */
const onUpdate = async (event) => {
    const { cluster, serviceName, desiredCount, deploymentConfiguration, healthCheckGracePeriodSeconds } = getProperties(event.ResourceProperties);
    const { service } = await ecs
        .updateService({
        service: serviceName,
        cluster,
        desiredCount,
        deploymentConfiguration,
        healthCheckGracePeriodSeconds,
    })
        .promise();
    if (!service)
        throw Error('Service could not be updated');
    return {
        PhysicalResourceId: service.serviceArn,
        Data: {
            ServiceName: service.serviceName,
        },
    };
};
const onDelete = async (event) => {
    const { cluster, serviceName } = getProperties(event.ResourceProperties);
    await ecs
        .deleteService({
        service: serviceName,
        cluster,
        force: true,
    })
        .promise();
    await ecs
        .waitFor('servicesInactive', {
        cluster,
        services: [serviceName],
    })
        .promise();
};
exports.handler = async (event) => {
    const requestType = event.RequestType;
    switch (requestType) {
        case 'Create':
            return onCreate(event);
        case 'Update':
            return onUpdate(event);
        case 'Delete':
            return onDelete(event);
        default:
            throw new Error(`Invalid request type: ${requestType}`);
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbGFtYmRhcy9lY3Mtc2VydmljZS9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFNQSxxQ0FBOEI7QUEwQjlCLE1BQU0sR0FBRyxHQUFHLElBQUksYUFBRyxFQUFFLENBQUM7QUFFdEIsTUFBTSxhQUFhLEdBQUcsQ0FBQyxLQUE4RCxFQUF5QixFQUFFLENBQUMsQ0FBQztJQUNoSCxPQUFPLEVBQUUsS0FBSyxDQUFDLE9BQU87SUFDdEIsV0FBVyxFQUFFLEtBQUssQ0FBQyxXQUFXO0lBQzlCLGFBQWEsRUFBRSxLQUFLLENBQUMsYUFBYTtJQUNsQyxjQUFjLEVBQUUsS0FBSyxDQUFDLGNBQWM7SUFDcEMsVUFBVSxFQUFFLEtBQUssQ0FBQyxVQUFVO0lBQzVCLGVBQWUsRUFBRSxLQUFLLENBQUMsZUFBZTtJQUN0QyxZQUFZLEVBQUUsS0FBSyxDQUFDLFlBQVk7SUFDaEMsT0FBTyxFQUFFLEtBQUssQ0FBQyxPQUFPO0lBQ3RCLGNBQWMsRUFBRSxLQUFLLENBQUMsY0FBYztJQUNwQyxjQUFjLEVBQUUsS0FBSyxDQUFDLGNBQWM7SUFDcEMsYUFBYSxFQUFFLEtBQUssQ0FBQyxhQUFhO0lBQ2xDLGtCQUFrQixFQUFFLEtBQUssQ0FBQyxrQkFBa0I7SUFDNUMsNkJBQTZCLEVBQUUsS0FBSyxDQUFDLHNCQUFzQjtJQUMzRCx1QkFBdUIsRUFBRSxLQUFLLENBQUMsdUJBQXVCO0NBQ3ZELENBQUMsQ0FBQztBQUVILE1BQU0sUUFBUSxHQUFHLEtBQUssRUFBRSxLQUE4QyxFQUEwQixFQUFFO0lBQ2hHLE1BQU0sRUFDSixPQUFPLEVBQ1AsV0FBVyxFQUNYLGFBQWEsRUFDYixjQUFjLEVBQ2QsVUFBVSxFQUNWLGVBQWUsRUFDZixZQUFZLEVBQ1osT0FBTyxFQUNQLGNBQWMsRUFDZCxjQUFjLEVBQ2QsYUFBYSxFQUNiLGtCQUFrQixFQUNsQiw2QkFBNkIsRUFDN0IsdUJB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S0FDM0Q7QUFDSCxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7XG4gIENsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VFdmVudCxcbiAgQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZUNyZWF0ZUV2ZW50LFxuICBDbG91ZEZvcm1hdGlvbkN1c3RvbVJlc291cmNlVXBkYXRlRXZlbnQsXG4gIENsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VEZWxldGVFdmVudCxcbn0gZnJvbSAnYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyBFQ1MgfSBmcm9tICdhd3Mtc2RrJztcblxuaW50ZXJmYWNlIEhhbmRsZXJSZXR1cm4ge1xuICBQaHlzaWNhbFJlc291cmNlSWQ6IHN0cmluZztcbiAgRGF0YToge1xuICAgIFNlcnZpY2VOYW1lOiBzdHJpbmc7XG4gIH07XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQmx1ZUdyZWVuU2VydmljZVByb3BzIHtcbiAgY2x1c3Rlcjogc3RyaW5nO1xuICBzZXJ2aWNlTmFtZTogc3RyaW5nO1xuICBjb250YWluZXJOYW1lOiBzdHJpbmc7XG4gIHRhc2tEZWZpbml0aW9uOiBzdHJpbmc7XG4gIGxhdW5jaFR5cGU6IHN0cmluZztcbiAgcGxhdGZvcm1WZXJzaW9uOiBzdHJpbmc7XG4gIGRlc2lyZWRDb3VudDogbnVtYmVyO1xuICBzdWJuZXRzOiBzdHJpbmdbXTtcbiAgc2VjdXJpdHlHcm91cHM6IHN0cmluZ1tdO1xuICB0YXJnZXRHcm91cEFybjogc3RyaW5nO1xuICBjb250YWluZXJQb3J0OiBudW1iZXI7XG4gIHNjaGVkdWxpbmdTdHJhdGVneTogc3RyaW5nO1xuICBoZWFsdGhDaGVja0dyYWNlUGVyaW9kU2Vjb25kczogbnVtYmVyO1xuICBkZXBsb3ltZW50Q29uZmlndXJhdGlvbjogRUNTLkRlcGxveW1lbnRDb25maWd1cmF0aW9uO1xufVxuXG5jb25zdCBlY3MgPSBuZXcgRUNTKCk7XG5cbmNvbnN0IGdldFByb3BlcnRpZXMgPSAocHJvcHM6IENsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VFdmVudFsnUmVzb3VyY2VQcm9wZXJ0aWVzJ10pOiBCbHVlR3JlZW5TZXJ2aWNlUHJvcHMgPT4gKHtcbiAgY2x1c3RlcjogcHJvcHMuQ2x1c3RlcixcbiAgc2VydmljZU5hbWU6IHByb3BzLlNlcnZpY2VOYW1lLFxuICBjb250YWluZXJOYW1lOiBwcm9wcy5Db250YWluZXJOYW1lLFxuICB0YXNrRGVmaW5pdGlvbjogcHJvcHMuVGFza0RlZmluaXRpb24sXG4gIGxhdW5jaFR5cGU6IHByb3BzLkxhdW5jaFR5cGUsXG4gIHBsYXRmb3JtVmVyc2lvbjogcHJvcHMuUGxhdGZvcm1WZXJzaW9uLFxuICBkZXNpcmVkQ291bnQ6IHByb3BzLkRlc2lyZWRDb3VudCxcbiAgc3VibmV0czogcHJvcHMuU3VibmV0cyxcbiAgc2VjdXJpdHlHcm91cHM6IHByb3BzLlNlY3VyaXR5R3JvdXBzLFxuICB0YXJnZXRHcm91cEFybjogcHJvcHMuVGFyZ2V0R3JvdXBBcm4sXG4gIGNvbnRhaW5lclBvcnQ6IHByb3BzLkNvbnRhaW5lclBvcnQsXG4gIHNjaGVkdWxpbmdTdHJhdGVneTogcHJvcHMuU2NoZWR1bGluZ1N0cmF0ZWd5LFxuICBoZWFsdGhDaGVja0dyYWNlUGVyaW9kU2Vjb25kczogcHJvcHMuSGVhbHRoQ2hlY2tHcmFjZVBlcmlvZCxcbiAgZGVwbG95bWVudENvbmZpZ3VyYXRpb246IHByb3BzLkRlcGxveW1lbnRDb25maWd1cmF0aW9uLFxufSk7XG5cbmNvbnN0IG9uQ3JlYXRlID0gYXN5bmMgKGV2ZW50OiBDbG91ZEZvcm1hdGlvbkN1c3RvbVJlc291cmNlQ3JlYXRlRXZlbnQpOiBQcm9taXNlPEhhbmRsZXJSZXR1cm4+ID0+IHtcbiAgY29uc3Qge1xuICAgIGNsdXN0ZXIsXG4gICAgc2VydmljZU5hbWUsXG4gICAgY29udGFpbmVyTmFtZSxcbiAgICB0YXNrRGVmaW5pdGlvbixcbiAgICBsYXVuY2hUeXBlLFxuICAgIHBsYXRmb3JtVmVyc2lvbixcbiAgICBkZXNpcmVkQ291bnQsXG4gICAgc3VibmV0cyxcbiAgICBzZWN1cml0eUdyb3VwcyxcbiAgICB0YXJnZXRHcm91cEFybixcbiAgICBjb250YWluZXJQb3J0LFxuICAgIHNjaGVkdWxpbmdTdHJhdGVneSxcbiAgICBoZWFsdGhDaGVja0dyYWNlUGVyaW9kU2Vjb25kcyxcbiAgICBkZXBsb3ltZW50Q29uZmlndXJhdGlvbixcbiAgfSA9IGdldFByb3BlcnRpZXMoZXZlbnQuUmVzb3VyY2VQcm9wZXJ0aWVzKTtcblxuICBjb25zdCB7IHNlcnZpY2UgfSA9IGF3YWl0IGVjc1xuICAgIC5jcmVhdGVTZXJ2aWNlKHtcbiAgICAgIGNsdXN0ZXIsXG4gICAgICBzZXJ2aWNlTmFtZSxcbiAgICAgIHRhc2tEZWZpbml0aW9uLFxuICAgICAgbGF1bmNoVHlwZSxcbiAgICAgIHBsYXRmb3JtVmVyc2lvbixcbiAgICAgIGRlc2lyZWRDb3VudCxcbiAgICAgIHNjaGVkdWxpbmdTdHJhdGVneSxcbiAgICAgIGRlcGxveW1lbnRDb250cm9sbGVyOiB7XG4gICAgICAgIHR5cGU6ICdDT0RFX0RFUExPWScsXG4gICAgICB9LFxuICAgICAgbmV0d29ya0NvbmZpZ3VyYXRpb246IHtcbiAgICAgICAgYXdzdnBjQ29uZmlndXJhdGlvbjoge1xuICAgICAgICAgIHN1Ym5ldHMsXG4gICAgICAgICAgc2VjdXJpdHlHcm91cHMsXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAgZGVwbG95bWVudENvbmZpZ3VyYXRpb24sXG4gICAgICBoZWFsdGhDaGVja0dyYWNlUGVyaW9kU2Vjb25kcyxcbiAgICAgIGxvYWRCYWxhbmNlcnM6IFtcbiAgICAgICAge1xuICAgICAgICAgIHRhcmdldEdyb3VwQXJuOiB0YXJnZXRHcm91cEFybixcbiAgICAgICAgICBjb250YWluZXJQb3J0LFxuICAgICAgICAgIGNvbnRhaW5lck5hbWUsXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgIH0pXG4gICAgLnByb21pc2UoKTtcblxuICBpZiAoIXNlcnZpY2UpIHRocm93IEVycm9yKCdTZXJ2aWNlIGNvdWxkIG5vdCBiZSBjcmVhdGVkJyk7XG5cbiAgcmV0dXJuIHtcbiAgICBQaHlzaWNhbFJlc291cmNlSWQ6IHNlcnZpY2Uuc2VydmljZUFybiBhcyBzdHJpbmcsXG4gICAgRGF0YToge1xuICAgICAgU2VydmljZU5hbWU6IHNlcnZpY2Uuc2VydmljZU5hbWUgYXMgc3RyaW5nLFxuICAgIH0sXG4gIH07XG59O1xuXG4vKipcbiAqIEZvciBzZXJ2aWNlcyB1c2luZyB0aGUgYmx1ZS9ncmVlbiAoQ09ERV9ERVBMT1kpIGRlcGxveW1lbnQgY29udHJvbGxlcixcbiAqIG9ubHkgdGhlIGRlc2lyZWQgY291bnQsIGRlcGxveW1lbnQgY29uZmlndXJhdGlvbiwgdGFzayBwbGFjZW1lbnQgY29uc3RyYWludHNcbiAqIGFuZCBzdHJhdGVnaWVzLCBhbmQgaGVhbHRoIGNoZWNrIGdyYWNlIHBlcmlvZCBjYW4gYmUgdXBkYXRlZCB1c2luZyB0aGlzIEFQSS5cbiAqIElmIHRoZSBuZXR3b3JrIGNvbmZpZ3VyYXRpb24sIHBsYXRmb3JtIHZlcnNpb24sIG9yIHRhc2sgZGVmaW5pdGlvbiBuZWVkIHRvIGJlXG4gKiB1cGRhdGVkLCBhIG5ldyBBV1MgQ29kZURlcGxveSBkZXBsb3ltZW50IHNob3VsZCBiZSBjcmVhdGVkLlxuICogRm9yIG1vcmUgaW5mb3JtYXRpb24sIHNlZSBDcmVhdGVEZXBsb3ltZW50IGluIHRoZSBBV1MgQ29kZURlcGxveSBBUEkgUmVmZXJlbmNlLlxuICovXG5jb25zdCBvblVwZGF0ZSA9IGFzeW5jIChldmVudDogQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZVVwZGF0ZUV2ZW50KTogUHJvbWlzZTxIYW5kbGVyUmV0dXJuPiA9PiB7XG4gIGNvbnN0IHsgY2x1c3Rlciwgc2VydmljZU5hbWUsIGRlc2lyZWRDb3VudCwgZGVwbG95bWVudENvbmZpZ3VyYXRpb24sIGhlYWx0aENoZWNrR3JhY2VQZXJpb2RTZWNvbmRzIH0gPSBnZXRQcm9wZXJ0aWVzKGV2ZW50LlJlc291cmNlUHJvcGVydGllcyk7XG5cbiAgY29uc3QgeyBzZXJ2aWNlIH0gPSBhd2FpdCBlY3NcbiAgICAudXBkYXRlU2VydmljZSh7XG4gICAgICBzZXJ2aWNlOiBzZXJ2aWNlTmFtZSxcbiAgICAgIGNsdXN0ZXIsXG4gICAgICBkZXNpcmVkQ291bnQsXG4gICAgICBkZXBsb3ltZW50Q29uZmlndXJhdGlvbixcbiAgICAgIGhlYWx0aENoZWNrR3JhY2VQZXJpb2RTZWNvbmRzLFxuICAgIH0pXG4gICAgLnByb21pc2UoKTtcblxuICBpZiAoIXNlcnZpY2UpIHRocm93IEVycm9yKCdTZXJ2aWNlIGNvdWxkIG5vdCBiZSB1cGRhdGVkJyk7XG5cbiAgcmV0dXJuIHtcbiAgICBQaHlzaWNhbFJlc291cmNlSWQ6IHNlcnZpY2Uuc2VydmljZUFybiBhcyBzdHJpbmcsXG4gICAgRGF0YToge1xuICAgICAgU2VydmljZU5hbWU6IHNlcnZpY2Uuc2VydmljZU5hbWUgYXMgc3RyaW5nLFxuICAgIH0sXG4gIH07XG59O1xuXG5jb25zdCBvbkRlbGV0ZSA9IGFzeW5jIChldmVudDogQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZURlbGV0ZUV2ZW50KTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gIGNvbnN0IHsgY2x1c3Rlciwgc2VydmljZU5hbWUgfSA9IGdldFByb3BlcnRpZXMoZXZlbnQuUmVzb3VyY2VQcm9wZXJ0aWVzKTtcblxuICBhd2FpdCBlY3NcbiAgICAuZGVsZXRlU2VydmljZSh7XG4gICAgICBzZXJ2aWNlOiBzZXJ2aWNlTmFtZSxcbiAgICAgIGNsdXN0ZXIsXG4gICAgICBmb3JjZTogdHJ1ZSxcbiAgICB9KVxuICAgIC5wcm9taXNlKCk7XG5cbiAgYXdhaXQgZWNzXG4gICAgLndhaXRGb3IoJ3NlcnZpY2VzSW5hY3RpdmUnLCB7XG4gICAgICBjbHVzdGVyLFxuICAgICAgc2VydmljZXM6IFtzZXJ2aWNlTmFtZV0sXG4gICAgfSlcbiAgICAucHJvbWlzZSgpO1xufTtcblxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoZXZlbnQ6IENsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VFdmVudCk6IFByb21pc2U8SGFuZGxlclJldHVybiB8IHZvaWQ+ID0+IHtcbiAgY29uc3QgcmVxdWVzdFR5cGUgPSBldmVudC5SZXF1ZXN0VHlwZTtcblxuICBzd2l0Y2ggKHJlcXVlc3RUeXBlKSB7XG4gICAgY2FzZSAnQ3JlYXRlJzpcbiAgICAgIHJldHVybiBvbkNyZWF0ZShldmVudCBhcyBDbG91ZEZvcm1hdGlvbkN1c3RvbVJlc291cmNlQ3JlYXRlRXZlbnQpO1xuICAgIGNhc2UgJ1VwZGF0ZSc6XG4gICAgICByZXR1cm4gb25VcGRhdGUoZXZlbnQgYXMgQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZVVwZGF0ZUV2ZW50KTtcbiAgICBjYXNlICdEZWxldGUnOlxuICAgICAgcmV0dXJuIG9uRGVsZXRlKGV2ZW50IGFzIENsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VEZWxldGVFdmVudCk7XG4gICAgZGVmYXVsdDpcbiAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCByZXF1ZXN0IHR5cGU6ICR7cmVxdWVzdFR5cGV9YCk7XG4gIH1cbn07XG4iXX0=