"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const aws_sdk_1 = require("aws-sdk");
const ecs = new aws_sdk_1.ECS();
const getProperties = (props) => ({
    cluster: props.Cluster,
    serviceName: props.ServiceName,
    containerName: props.ContainerName,
    taskDefinition: props.TaskDefinition,
    launchType: props.LaunchType,
    platformVersion: props.PlatformVersion,
    desiredCount: props.DesiredCount,
    subnets: props.Subnets,
    securityGroups: props.SecurityGroups,
    targetGroupArn: props.TargetGroupArn,
    containerPort: props.ContainerPort,
    schedulingStrategy: props.SchedulingStrategy,
    healthCheckGracePeriodSeconds: props.HealthCheckGracePeriodSeconds,
    deploymentConfiguration: props.DeploymentConfiguration,
});
const onCreate = async (event) => {
    const { cluster, serviceName, containerName, taskDefinition, launchType, platformVersion, desiredCount, subnets, securityGroups, targetGroupArn, containerPort, schedulingStrategy, healthCheckGracePeriodSeconds, deploymentConfiguration, } = getProperties(event.ResourceProperties);
    const { service } = await ecs
        .createService({
        cluster,
        serviceName,
        taskDefinition,
        launchType,
        platformVersion,
        desiredCount,
        schedulingStrategy,
        deploymentController: {
            type: 'CODE_DEPLOY',
        },
        networkConfiguration: {
            awsvpcConfiguration: {
                subnets,
                securityGroups,
            },
        },
        deploymentConfiguration,
        healthCheckGracePeriodSeconds,
        loadBalancers: [
            {
                targetGroupArn: targetGroupArn,
                containerPort,
                containerName,
            },
        ],
    })
        .promise();
    if (!service)
        throw Error('Service could not be created');
    return {
        PhysicalResourceId: service.serviceArn,
        Data: {
            ServiceName: service.serviceName,
        },
    };
};
/**
 * For services using the blue/green (CODE_DEPLOY) deployment controller,
 * only the desired count, deployment configuration, task placement constraints
 * and strategies, and health check grace period can be updated using this API.
 * If the network configuration, platform version, or task definition need to be
 * updated, a new AWS CodeDeploy deployment should be created.
 * For more information, see CreateDeployment in the AWS CodeDeploy API Reference.
 */
const onUpdate = async (event) => {
    const { cluster, serviceName, desiredCount, deploymentConfiguration, healthCheckGracePeriodSeconds } = getProperties(event.ResourceProperties);
    const { service } = await ecs
        .updateService({
        service: serviceName,
        cluster,
        desiredCount,
        deploymentConfiguration,
        healthCheckGracePeriodSeconds,
    })
        .promise();
    if (!service)
        throw Error('Service could not be updated');
    return {
        PhysicalResourceId: service.serviceArn,
        Data: {
            ServiceName: service.serviceName,
        },
    };
};
const onDelete = async (event) => {
    const { cluster, serviceName } = getProperties(event.ResourceProperties);
    await ecs
        .deleteService({
        service: serviceName,
        cluster,
        force: true,
    })
        .promise();
    await ecs
        .waitFor('servicesInactive', {
        cluster,
        services: [serviceName],
    })
        .promise();
};
exports.handler = async (event) => {
    const requestType = event.RequestType;
    switch (requestType) {
        case 'Create':
            return onCreate(event);
        case 'Update':
            return onUpdate(event);
        case 'Delete':
            return onDelete(event);
        default:
            throw new Error(`Invalid request type: ${requestType}`);
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbGFtYmRhcy9lY3Mtc2VydmljZS9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFNQSxxQ0FBOEI7QUEwQjlCLE1BQU0sR0FBRyxHQUFHLElBQUksYUFBRyxFQUFFLENBQUM7QUFFdEIsTUFBTSxhQUFhLEdBQUcsQ0FBQyxLQUE4RCxFQUF5QixFQUFFLENBQUMsQ0FBQztJQUNoSCxPQUFPLEVBQUUsS0FBSyxDQUFDLE9BQU87SUFDdEIsV0FBVyxFQUFFLEtBQUssQ0FBQyxXQUFXO0lBQzlCLGFBQWEsRUFBRSxLQUFLLENBQUMsYUFBYTtJQUNsQyxjQUFjLEVBQUUsS0FBSyxDQUFDLGNBQWM7SUFDcEMsVUFBVSxFQUFFLEtBQUssQ0FBQyxVQUFVO0lBQzVCLGVBQWUsRUFBRSxLQUFLLENBQUMsZUFBZTtJQUN0QyxZQUFZLEVBQUUsS0FBSyxDQUFDLFlBQVk7SUFDaEMsT0FBTyxFQUFFLEtBQUssQ0FBQyxPQUFPO0lBQ3RCLGNBQWMsRUFBRSxLQUFLLENBQUMsY0FBYztJQUNwQyxjQUFjLEVBQUUsS0FBSyxDQUFDLGNBQWM7SUFDcEMsYUFBYSxFQUFFLEtBQUssQ0FBQyxhQUFhO0lBQ2xDLGtCQUFrQixFQUFFLEtBQUssQ0FBQyxrQkFBa0I7SUFDNUMsNkJBQTZCLEVBQUUsS0FBSyxDQUFDLDZCQUE2QjtJQUNsRSx1QkFBdUIsRUFBRSxLQUFLLENBQUMsdUJBQXVCO0NBQ3ZELENBQUMsQ0FBQztBQUVILE1BQU0sUUFBUSxHQUFHLEtBQUssRUFBRSxLQUE4QyxFQUEwQixFQUFFO0lBQ2hHLE1BQU0sRUFDSixPQUFPLEVBQ1AsV0FBVyxFQUNYLGFBQWEsRUFDYixjQUFjLEVBQ2QsVUFBVSxFQUNWLGVBQWUsRUFDZixZQUFZLEVBQ1osT0FBTyxFQUNQLGNBQWMsRUFDZCxjQUFjLEVBQ2QsYUFBYSxFQUNiLGtCQUFrQixFQUNsQiw2QkFBNkIsRUFDN0IsdUJB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S0FDM0Q7QUFDSCxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7XHJcbiAgQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZUV2ZW50LFxyXG4gIENsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VDcmVhdGVFdmVudCxcclxuICBDbG91ZEZvcm1hdGlvbkN1c3RvbVJlc291cmNlVXBkYXRlRXZlbnQsXHJcbiAgQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZURlbGV0ZUV2ZW50LFxyXG59IGZyb20gJ2F3cy1sYW1iZGEnO1xyXG5pbXBvcnQgeyBFQ1MgfSBmcm9tICdhd3Mtc2RrJztcclxuXHJcbmludGVyZmFjZSBIYW5kbGVyUmV0dXJuIHtcclxuICBQaHlzaWNhbFJlc291cmNlSWQ6IHN0cmluZztcclxuICBEYXRhOiB7XHJcbiAgICBTZXJ2aWNlTmFtZTogc3RyaW5nO1xyXG4gIH07XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgQmx1ZUdyZWVuU2VydmljZVByb3BzIHtcclxuICBjbHVzdGVyOiBzdHJpbmc7XHJcbiAgc2VydmljZU5hbWU6IHN0cmluZztcclxuICBjb250YWluZXJOYW1lOiBzdHJpbmc7XHJcbiAgdGFza0RlZmluaXRpb246IHN0cmluZztcclxuICBsYXVuY2hUeXBlOiBzdHJpbmc7XHJcbiAgcGxhdGZvcm1WZXJzaW9uOiBzdHJpbmc7XHJcbiAgZGVzaXJlZENvdW50OiBudW1iZXI7XHJcbiAgc3VibmV0czogc3RyaW5nW107XHJcbiAgc2VjdXJpdHlHcm91cHM6IHN0cmluZ1tdO1xyXG4gIHRhcmdldEdyb3VwQXJuOiBzdHJpbmc7XHJcbiAgY29udGFpbmVyUG9ydDogbnVtYmVyO1xyXG4gIHNjaGVkdWxpbmdTdHJhdGVneTogc3RyaW5nO1xyXG4gIGhlYWx0aENoZWNrR3JhY2VQZXJpb2RTZWNvbmRzOiBudW1iZXI7XHJcbiAgZGVwbG95bWVudENvbmZpZ3VyYXRpb246IEVDUy5EZXBsb3ltZW50Q29uZmlndXJhdGlvbjtcclxufVxyXG5cclxuY29uc3QgZWNzID0gbmV3IEVDUygpO1xyXG5cclxuY29uc3QgZ2V0UHJvcGVydGllcyA9IChwcm9wczogQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZUV2ZW50WydSZXNvdXJjZVByb3BlcnRpZXMnXSk6IEJsdWVHcmVlblNlcnZpY2VQcm9wcyA9PiAoe1xyXG4gIGNsdXN0ZXI6IHByb3BzLkNsdXN0ZXIsXHJcbiAgc2VydmljZU5hbWU6IHByb3BzLlNlcnZpY2VOYW1lLFxyXG4gIGNvbnRhaW5lck5hbWU6IHByb3BzLkNvbnRhaW5lck5hbWUsXHJcbiAgdGFza0RlZmluaXRpb246IHByb3BzLlRhc2tEZWZpbml0aW9uLFxyXG4gIGxhdW5jaFR5cGU6IHByb3BzLkxhdW5jaFR5cGUsXHJcbiAgcGxhdGZvcm1WZXJzaW9uOiBwcm9wcy5QbGF0Zm9ybVZlcnNpb24sXHJcbiAgZGVzaXJlZENvdW50OiBwcm9wcy5EZXNpcmVkQ291bnQsXHJcbiAgc3VibmV0czogcHJvcHMuU3VibmV0cyxcclxuICBzZWN1cml0eUdyb3VwczogcHJvcHMuU2VjdXJpdHlHcm91cHMsXHJcbiAgdGFyZ2V0R3JvdXBBcm46IHByb3BzLlRhcmdldEdyb3VwQXJuLFxyXG4gIGNvbnRhaW5lclBvcnQ6IHByb3BzLkNvbnRhaW5lclBvcnQsXHJcbiAgc2NoZWR1bGluZ1N0cmF0ZWd5OiBwcm9wcy5TY2hlZHVsaW5nU3RyYXRlZ3ksXHJcbiAgaGVhbHRoQ2hlY2tHcmFjZVBlcmlvZFNlY29uZHM6IHByb3BzLkhlYWx0aENoZWNrR3JhY2VQZXJpb2RTZWNvbmRzLFxyXG4gIGRlcGxveW1lbnRDb25maWd1cmF0aW9uOiBwcm9wcy5EZXBsb3ltZW50Q29uZmlndXJhdGlvbixcclxufSk7XHJcblxyXG5jb25zdCBvbkNyZWF0ZSA9IGFzeW5jIChldmVudDogQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZUNyZWF0ZUV2ZW50KTogUHJvbWlzZTxIYW5kbGVyUmV0dXJuPiA9PiB7XHJcbiAgY29uc3Qge1xyXG4gICAgY2x1c3RlcixcclxuICAgIHNlcnZpY2VOYW1lLFxyXG4gICAgY29udGFpbmVyTmFtZSxcclxuICAgIHRhc2tEZWZpbml0aW9uLFxyXG4gICAgbGF1bmNoVHlwZSxcclxuICAgIHBsYXRmb3JtVmVyc2lvbixcclxuICAgIGRlc2lyZWRDb3VudCxcclxuICAgIHN1Ym5ldHMsXHJcbiAgICBzZWN1cml0eUdyb3VwcyxcclxuICAgIHRhcmdldEdyb3VwQXJuLFxyXG4gICAgY29udGFpbmVyUG9ydCxcclxuICAgIHNjaGVkdWxpbmdTdHJhdGVneSxcclxuICAgIGhlYWx0aENoZWNrR3JhY2VQZXJpb2RTZWNvbmRzLFxyXG4gICAgZGVwbG95bWVudENvbmZpZ3VyYXRpb24sXHJcbiAgfSA9IGdldFByb3BlcnRpZXMoZXZlbnQuUmVzb3VyY2VQcm9wZXJ0aWVzKTtcclxuXHJcbiAgY29uc3QgeyBzZXJ2aWNlIH0gPSBhd2FpdCBlY3NcclxuICAgIC5jcmVhdGVTZXJ2aWNlKHtcclxuICAgICAgY2x1c3RlcixcclxuICAgICAgc2VydmljZU5hbWUsXHJcbiAgICAgIHRhc2tEZWZpbml0aW9uLFxyXG4gICAgICBsYXVuY2hUeXBlLFxyXG4gICAgICBwbGF0Zm9ybVZlcnNpb24sXHJcbiAgICAgIGRlc2lyZWRDb3VudCxcclxuICAgICAgc2NoZWR1bGluZ1N0cmF0ZWd5LFxyXG4gICAgICBkZXBsb3ltZW50Q29udHJvbGxlcjoge1xyXG4gICAgICAgIHR5cGU6ICdDT0RFX0RFUExPWScsXHJcbiAgICAgIH0sXHJcbiAgICAgIG5ldHdvcmtDb25maWd1cmF0aW9uOiB7XHJcbiAgICAgICAgYXdzdnBjQ29uZmlndXJhdGlvbjoge1xyXG4gICAgICAgICAgc3VibmV0cyxcclxuICAgICAgICAgIHNlY3VyaXR5R3JvdXBzLFxyXG4gICAgICAgIH0sXHJcbiAgICAgIH0sXHJcbiAgICAgIGRlcGxveW1lbnRDb25maWd1cmF0aW9uLFxyXG4gICAgICBoZWFsdGhDaGVja0dyYWNlUGVyaW9kU2Vjb25kcyxcclxuICAgICAgbG9hZEJhbGFuY2VyczogW1xyXG4gICAgICAgIHtcclxuICAgICAgICAgIHRhcmdldEdyb3VwQXJuOiB0YXJnZXRHcm91cEFybixcclxuICAgICAgICAgIGNvbnRhaW5lclBvcnQsXHJcbiAgICAgICAgICBjb250YWluZXJOYW1lLFxyXG4gICAgICAgIH0sXHJcbiAgICAgIF0sXHJcbiAgICB9KVxyXG4gICAgLnByb21pc2UoKTtcclxuXHJcbiAgaWYgKCFzZXJ2aWNlKSB0aHJvdyBFcnJvcignU2VydmljZSBjb3VsZCBub3QgYmUgY3JlYXRlZCcpO1xyXG5cclxuICByZXR1cm4ge1xyXG4gICAgUGh5c2ljYWxSZXNvdXJjZUlkOiBzZXJ2aWNlLnNlcnZpY2VBcm4gYXMgc3RyaW5nLFxyXG4gICAgRGF0YToge1xyXG4gICAgICBTZXJ2aWNlTmFtZTogc2VydmljZS5zZXJ2aWNlTmFtZSBhcyBzdHJpbmcsXHJcbiAgICB9LFxyXG4gIH07XHJcbn07XHJcblxyXG4vKipcclxuICogRm9yIHNlcnZpY2VzIHVzaW5nIHRoZSBibHVlL2dyZWVuIChDT0RFX0RFUExPWSkgZGVwbG95bWVudCBjb250cm9sbGVyLFxyXG4gKiBvbmx5IHRoZSBkZXNpcmVkIGNvdW50LCBkZXBsb3ltZW50IGNvbmZpZ3VyYXRpb24sIHRhc2sgcGxhY2VtZW50IGNvbnN0cmFpbnRzXHJcbiAqIGFuZCBzdHJhdGVnaWVzLCBhbmQgaGVhbHRoIGNoZWNrIGdyYWNlIHBlcmlvZCBjYW4gYmUgdXBkYXRlZCB1c2luZyB0aGlzIEFQSS5cclxuICogSWYgdGhlIG5ldHdvcmsgY29uZmlndXJhdGlvbiwgcGxhdGZvcm0gdmVyc2lvbiwgb3IgdGFzayBkZWZpbml0aW9uIG5lZWQgdG8gYmVcclxuICogdXBkYXRlZCwgYSBuZXcgQVdTIENvZGVEZXBsb3kgZGVwbG95bWVudCBzaG91bGQgYmUgY3JlYXRlZC5cclxuICogRm9yIG1vcmUgaW5mb3JtYXRpb24sIHNlZSBDcmVhdGVEZXBsb3ltZW50IGluIHRoZSBBV1MgQ29kZURlcGxveSBBUEkgUmVmZXJlbmNlLlxyXG4gKi9cclxuY29uc3Qgb25VcGRhdGUgPSBhc3luYyAoZXZlbnQ6IENsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VVcGRhdGVFdmVudCk6IFByb21pc2U8SGFuZGxlclJldHVybj4gPT4ge1xyXG4gIGNvbnN0IHsgY2x1c3Rlciwgc2VydmljZU5hbWUsIGRlc2lyZWRDb3VudCwgZGVwbG95bWVudENvbmZpZ3VyYXRpb24sIGhlYWx0aENoZWNrR3JhY2VQZXJpb2RTZWNvbmRzIH0gPSBnZXRQcm9wZXJ0aWVzKGV2ZW50LlJlc291cmNlUHJvcGVydGllcyk7XHJcblxyXG4gIGNvbnN0IHsgc2VydmljZSB9ID0gYXdhaXQgZWNzXHJcbiAgICAudXBkYXRlU2VydmljZSh7XHJcbiAgICAgIHNlcnZpY2U6IHNlcnZpY2VOYW1lLFxyXG4gICAgICBjbHVzdGVyLFxyXG4gICAgICBkZXNpcmVkQ291bnQsXHJcbiAgICAgIGRlcGxveW1lbnRDb25maWd1cmF0aW9uLFxyXG4gICAgICBoZWFsdGhDaGVja0dyYWNlUGVyaW9kU2Vjb25kcyxcclxuICAgIH0pXHJcbiAgICAucHJvbWlzZSgpO1xyXG5cclxuICBpZiAoIXNlcnZpY2UpIHRocm93IEVycm9yKCdTZXJ2aWNlIGNvdWxkIG5vdCBiZSB1cGRhdGVkJyk7XHJcblxyXG4gIHJldHVybiB7XHJcbiAgICBQaHlzaWNhbFJlc291cmNlSWQ6IHNlcnZpY2Uuc2VydmljZUFybiBhcyBzdHJpbmcsXHJcbiAgICBEYXRhOiB7XHJcbiAgICAgIFNlcnZpY2VOYW1lOiBzZXJ2aWNlLnNlcnZpY2VOYW1lIGFzIHN0cmluZyxcclxuICAgIH0sXHJcbiAgfTtcclxufTtcclxuXHJcbmNvbnN0IG9uRGVsZXRlID0gYXN5bmMgKGV2ZW50OiBDbG91ZEZvcm1hdGlvbkN1c3RvbVJlc291cmNlRGVsZXRlRXZlbnQpOiBQcm9taXNlPHZvaWQ+ID0+IHtcclxuICBjb25zdCB7IGNsdXN0ZXIsIHNlcnZpY2VOYW1lIH0gPSBnZXRQcm9wZXJ0aWVzKGV2ZW50LlJlc291cmNlUHJvcGVydGllcyk7XHJcblxyXG4gIGF3YWl0IGVjc1xyXG4gICAgLmRlbGV0ZVNlcnZpY2Uoe1xyXG4gICAgICBzZXJ2aWNlOiBzZXJ2aWNlTmFtZSxcclxuICAgICAgY2x1c3RlcixcclxuICAgICAgZm9yY2U6IHRydWUsXHJcbiAgICB9KVxyXG4gICAgLnByb21pc2UoKTtcclxuXHJcbiAgYXdhaXQgZWNzXHJcbiAgICAud2FpdEZvcignc2VydmljZXNJbmFjdGl2ZScsIHtcclxuICAgICAgY2x1c3RlcixcclxuICAgICAgc2VydmljZXM6IFtzZXJ2aWNlTmFtZV0sXHJcbiAgICB9KVxyXG4gICAgLnByb21pc2UoKTtcclxufTtcclxuXHJcbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gYXN5bmMgKGV2ZW50OiBDbG91ZEZvcm1hdGlvbkN1c3RvbVJlc291cmNlRXZlbnQpOiBQcm9taXNlPEhhbmRsZXJSZXR1cm4gfCB2b2lkPiA9PiB7XHJcbiAgY29uc3QgcmVxdWVzdFR5cGUgPSBldmVudC5SZXF1ZXN0VHlwZTtcclxuXHJcbiAgc3dpdGNoIChyZXF1ZXN0VHlwZSkge1xyXG4gICAgY2FzZSAnQ3JlYXRlJzpcclxuICAgICAgcmV0dXJuIG9uQ3JlYXRlKGV2ZW50IGFzIENsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VDcmVhdGVFdmVudCk7XHJcbiAgICBjYXNlICdVcGRhdGUnOlxyXG4gICAgICByZXR1cm4gb25VcGRhdGUoZXZlbnQgYXMgQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZVVwZGF0ZUV2ZW50KTtcclxuICAgIGNhc2UgJ0RlbGV0ZSc6XHJcbiAgICAgIHJldHVybiBvbkRlbGV0ZShldmVudCBhcyBDbG91ZEZvcm1hdGlvbkN1c3RvbVJlc291cmNlRGVsZXRlRXZlbnQpO1xyXG4gICAgZGVmYXVsdDpcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIHJlcXVlc3QgdHlwZTogJHtyZXF1ZXN0VHlwZX1gKTtcclxuICB9XHJcbn07XHJcbiJdfQ==